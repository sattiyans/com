---
// Simple Floating AI Chatbot Input
---

<!-- Enhanced floating input bar -->
<div class="fixed bottom-6 left-1/2 transform -translate-x-1/2 z-50 chatbot-wrapper w-full px-4">
  <!-- Mobile collapsed state -->
  <div class="chatbot-mobile-collapsed sm:hidden bg-gray-100 dark:bg-black rounded-full shadow-2xl border border-black/15 dark:border-white/20 w-12 h-12 mx-auto backdrop-blur-sm hover:bg-gray-200 dark:hover:bg-black/80 transition-all duration-300 flex items-center justify-center cursor-pointer">
    <svg class="w-6 h-6 text-blue-500 dark:text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"></path>
    </svg>
  </div>
  
  <!-- Desktop/expanded state -->
  <div class="chatbot-container hidden sm:block max-w-lg w-full mx-auto">
    <!-- Response Display Area -->
    <div id="chatbot-response" class="chatbot-response mb-3 bg-gray-100 dark:bg-black rounded-2xl shadow-xl border border-black/15 dark:border-white/20 p-4 backdrop-blur-sm overflow-y-auto transition-all duration-300 opacity-0 transform translate-y-4 pointer-events-none" style="max-height: calc(100vh - 200px);">
      <div class="flex flex-col h-full">
        <div class="flex items-start gap-3 flex-1 relative">
          <div class="flex-shrink-0 mt-0.5">
            <svg class="w-4 h-4 text-blue-500 dark:text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"></path>
            </svg>
          </div>
          <div class="flex-1 text-sm text-gray-900 dark:text-white chatbot-response-text"></div>
          <button id="chatbot-close-btn" class="chatbot-close-btn flex-shrink-0 ml-2 mt-0.5 text-gray-400 dark:text-gray-500 hover:text-gray-600 dark:hover:text-gray-300 transition-colors opacity-0 pointer-events-none" aria-label="Close response">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
          </button>
        </div>
        <div class="mt-3 pt-3 border-t border-gray-300 dark:border-gray-700">
          <p class="text-xs text-gray-500 dark:text-gray-400 text-center">
            Powered by <a href="https://usenadi.com" target="_blank" rel="noopener noreferrer" class="text-blue-500 dark:text-blue-400 hover:underline">Nadi</a>
          </p>
        </div>
      </div>
    </div>
    
    <!-- Input Container -->
    <div class="bg-gray-100 dark:bg-black rounded-full shadow-2xl border border-black/15 dark:border-white/20 backdrop-blur-sm hover:bg-gray-200 dark:hover:bg-black/80 transition-all duration-300">
      <div class="px-6 py-4 relative">
        <div class="flex items-center gap-3">
          <!-- AI Icon -->
          <div class="ai-icon flex-shrink-0 chatbot-element">
            <svg class="w-5 h-5 text-blue-500 dark:text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"></path>
            </svg>
          </div>
          
          <!-- Input Field -->
          <input 
            type="text" 
            id="chatbot-input" 
            placeholder="Ask me anything..." 
            class="chatbot-input chatbot-element w-full bg-transparent text-gray-900 dark:text-white placeholder-gray-700 dark:placeholder-gray-300 focus:outline-none text-sm transition-all duration-300 focus:scale-105"
            style="font-size: 16px;"
          />
          
          <!-- Send Icon -->
          <div class="send-icon flex-shrink-0 opacity-0 transition-all duration-300 chatbot-element hover:text-blue-500 dark:hover:text-blue-400">
            <svg class="w-5 h-5 text-gray-400 dark:text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
            </svg>
          </div>
        </div>
        
        <!-- Animated Border -->
        <div class="animated-border"></div>
      </div>
    </div>
  </div>
  
  <!-- Mobile expanded state (hidden by default) -->
  <div class="chatbot-mobile-expanded hidden sm:hidden max-w-xs w-full mx-auto">
    <!-- Response Display Area (Mobile) -->
    <div id="chatbot-response-mobile" class="chatbot-response mb-2 bg-gray-100 dark:bg-black rounded-2xl shadow-xl border border-black/15 dark:border-white/20 p-3 backdrop-blur-sm overflow-y-auto transition-all duration-300 opacity-0 transform translate-y-4 pointer-events-none" style="max-height: calc(100vh - 180px);">
      <div class="flex flex-col h-full">
        <div class="flex items-start gap-2 flex-1 relative">
          <div class="flex-shrink-0 mt-0.5">
            <svg class="w-3 h-3 text-blue-500 dark:text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"></path>
            </svg>
          </div>
          <div class="flex-1 text-xs text-gray-900 dark:text-white chatbot-response-text-mobile"></div>
          <button id="chatbot-close-btn-mobile" class="chatbot-close-btn flex-shrink-0 ml-1 mt-0.5 text-gray-400 dark:text-gray-500 hover:text-gray-600 dark:hover:text-gray-300 transition-colors opacity-0 pointer-events-none" aria-label="Close response">
            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
          </button>
        </div>
        <div class="mt-2 pt-2 border-t border-gray-300 dark:border-gray-700">
          <p class="text-xs text-gray-500 dark:text-gray-400 text-center">
            Powered by <a href="https://usenadi.com" target="_blank" rel="noopener noreferrer" class="text-blue-500 dark:text-blue-400 hover:underline">Nadi</a>
          </p>
        </div>
      </div>
    </div>
    
    <!-- Input Container (Mobile) -->
    <div class="bg-gray-100 dark:bg-black rounded-full shadow-2xl border border-black/15 dark:border-white/20 backdrop-blur-sm hover:bg-gray-200 dark:hover:bg-black/80 transition-all duration-500">
      <div class="px-4 py-3 relative">
        <div class="flex items-center gap-2">
          <!-- AI Icon -->
          <div class="ai-icon flex-shrink-0">
            <svg class="w-4 h-4 text-blue-500 dark:text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"></path>
            </svg>
          </div>
          
          <!-- Input Field -->
          <input 
            type="text" 
            id="chatbot-mobile-input" 
            placeholder="Ask me anything..." 
            class="chatbot-mobile-input w-full bg-transparent text-gray-900 dark:text-white placeholder-gray-700 dark:placeholder-gray-300 focus:outline-none text-sm transition-all duration-300"
            style="font-size: 16px;"
          />
          
          <!-- Send Icon -->
          <div class="send-icon-mobile flex-shrink-0 opacity-0 transition-all duration-300 hover:text-blue-500 dark:hover:text-blue-400">
            <svg class="w-4 h-4 text-gray-400 dark:text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
            </svg>
          </div>
        </div>
        
        <!-- Animated Border -->
        <div class="animated-border-mobile"></div>
      </div>
    </div>
  </div>
</div>

<style>
  /* Chatbot Wrapper - Entrance Animation */
  .chatbot-wrapper {
    opacity: 0;
    transform: translateX(-50%) translateY(100px) scale(0.8);
    animation: slideInUp 0.8s cubic-bezier(0.4, 0, 0.2, 1) 0.5s forwards;
  }
  
  @keyframes slideInUp {
    0% {
      opacity: 0;
      transform: translateX(-50%) translateY(100px) scale(0.8);
    }
    60% {
      opacity: 1;
      transform: translateX(-50%) translateY(-10px) scale(1.05);
    }
    100% {
      opacity: 1;
      transform: translateX(-50%) translateY(0) scale(1);
    }
  }
  
  /* Enhanced Chatbot Container */
  .chatbot-container {
    position: relative;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }
  
  .chatbot-container:hover {
    transform: translateY(-2px);
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25), 0 0 0 1px rgba(59, 130, 246, 0.1);
  }
  
  .dark .chatbot-container:hover {
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5), 0 0 0 1px rgba(59, 130, 246, 0.2);
  }
  
  .chatbot-container.focused {
    transform: translateY(-2px);
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25), 0 0 0 1px rgba(59, 130, 246, 0.3);
    border-color: rgba(59, 130, 246, 0.3);
  }
  
  .dark .chatbot-container.focused {
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5), 0 0 0 1px rgba(59, 130, 246, 0.4);
    border-color: rgba(59, 130, 246, 0.4);
  }
  
  /* AI Icon Animation */
  .ai-icon {
    animation: aiPulse 2s infinite ease-in-out;
  }
  
  @keyframes aiPulse {
    0%, 100% {
      transform: scale(1);
      opacity: 1;
    }
    50% {
      transform: scale(1.1);
      opacity: 0.8;
    }
  }
  
  /* Input Field Enhancements */
  .chatbot-input {
    position: relative;
    z-index: 2;
    font-size: 16px !important; /* Prevent zoom on mobile */
  }
  
  /* Mobile collapsed circle animation */
  .chatbot-mobile-collapsed {
    animation: aiPulse 2s infinite ease-in-out;
  }
  
  .chatbot-mobile-collapsed:hover {
    transform: scale(1.1);
  }
  
  /* Mobile expanded state animations */
  .chatbot-mobile-expanded {
    transform: scale(0.8);
    opacity: 0;
  }
  
  .chatbot-mobile-expanded.expanded {
    transform: scale(1);
    opacity: 1;
  }
  
  .chatbot-mobile-expanded .chatbot-mobile-input {
    min-height: 28px;
  }
  
  .chatbot-mobile-expanded .animated-border-mobile {
    position: absolute;
    bottom: 0;
    left: 50%;
    transform: translateX(-50%);
    width: 0;
    height: 2px;
    background: linear-gradient(90deg, #3b82f6, #8b5cf6, #06b6d4);
    border-radius: 1px;
    transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }
  
  .dark .chatbot-mobile-expanded .animated-border-mobile {
    background: linear-gradient(90deg, #60a5fa, #a78bfa, #22d3ee);
  }
  
  .chatbot-mobile-input:focus ~ .animated-border-mobile {
    width: 80%;
    animation: borderGlow 2s infinite ease-in-out;
  }
  
  .dark .chatbot-mobile-input:focus ~ .animated-border-mobile {
    animation: borderGlowDark 2s infinite ease-in-out;
  }
  
  /* Mobile optimizations */
  @media (max-width: 640px) {
    .chatbot-wrapper {
      padding-left: 1rem;
      padding-right: 1rem;
      bottom: 1rem; /* Add bottom padding */
    }
  }
  
  .chatbot-input:focus + .send-icon {
    opacity: 1;
    transform: translateX(0);
  }
  
  .chatbot-input:not(:placeholder-shown) + .send-icon {
    opacity: 1;
    transform: translateX(0);
  }
  
  /* Send Icon Animation */
  .send-icon {
    transform: translateX(10px);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }
  
  .send-icon:hover {
    transform: translateX(0) scale(1.1);
  }
  
  /* Animated Border */
  .animated-border {
    position: absolute;
    bottom: 0;
    left: 50%;
    transform: translateX(-50%);
    width: 0;
    height: 2px;
    background: linear-gradient(90deg, #3b82f6, #8b5cf6, #06b6d4);
    border-radius: 1px;
    transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }
  
  .dark .animated-border {
    background: linear-gradient(90deg, #60a5fa, #a78bfa, #22d3ee);
  }
  
  .chatbot-input:focus ~ .animated-border {
    width: 80%;
    animation: borderGlow 2s infinite ease-in-out;
  }
  
  .dark .chatbot-input:focus ~ .animated-border {
    animation: borderGlowDark 2s infinite ease-in-out;
  }
  
  @keyframes borderGlow {
    0%, 100% {
      box-shadow: 0 0 5px rgba(59, 130, 246, 0.5);
    }
    50% {
      box-shadow: 0 0 20px rgba(59, 130, 246, 0.8);
    }
  }
  
  @keyframes borderGlowDark {
    0%, 100% {
      box-shadow: 0 0 5px rgba(96, 165, 250, 0.6);
    }
    50% {
      box-shadow: 0 0 20px rgba(96, 165, 250, 0.9);
    }
  }
  
  /* Staggered Element Animation */
  .chatbot-element {
    opacity: 0;
    transform: translateY(20px);
    animation: elementSlideIn 0.6s cubic-bezier(0.4, 0, 0.2, 1) forwards;
  }
  
  .chatbot-element:nth-child(1) {
    animation-delay: 0.8s;
  }
  
  .chatbot-element:nth-child(2) {
    animation-delay: 1.0s;
  }
  
  .chatbot-element:nth-child(3) {
    animation-delay: 1.2s;
  }
  
  @keyframes elementSlideIn {
    0% {
      opacity: 0;
      transform: translateY(20px);
    }
    100% {
      opacity: 1;
      transform: translateY(0);
    }
  }
  
  /* Floating Animation */
  .chatbot-container {
    animation: float 6s ease-in-out infinite;
  }
  
  @keyframes float {
    0%, 100% {
      transform: translateY(0px);
    }
    50% {
      transform: translateY(-3px);
    }
  }
  
  /* Typing Indicator */
  .typing-indicator {
    display: inline-flex;
    align-items: center;
    gap: 4px;
  }
  
  .typing-dot {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background-color: #6b7280;
    animation: typing 1.4s infinite ease-in-out;
  }
  
  .typing-dot:nth-child(1) { animation-delay: -0.32s; }
  .typing-dot:nth-child(2) { animation-delay: -0.16s; }
  .typing-dot:nth-child(3) { animation-delay: 0s; }
  
  @keyframes typing {
    0%, 80%, 100% {
      transform: scale(0.8);
      opacity: 0.5;
    }
    40% {
      transform: scale(1);
      opacity: 1;
    }
  }
  
  .message-slide-in {
    animation: slideIn 0.3s ease-out;
  }
  
  @keyframes slideIn {
    from {
      opacity: 0;
      transform: translateY(10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
  
  /* Success Animation */
  .success-animation {
    animation: successPulse 2s ease-in-out;
  }
  
  @keyframes successPulse {
    0% {
      transform: translate(-50%, 0) scale(1);
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
    }
    25% {
      transform: translate(-50%, 0) scale(1.05);
      box-shadow: 0 25px 50px -12px rgba(34, 197, 94, 0.4);
    }
    50% {
      transform: translate(-50%, 0) scale(1.02);
      box-shadow: 0 25px 50px -12px rgba(34, 197, 94, 0.6);
    }
    75% {
      transform: translate(-50%, 0) scale(1.05);
      box-shadow: 0 25px 50px -12px rgba(34, 197, 94, 0.4);
    }
    100% {
      transform: translate(-50%, 0) scale(1);
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
    }
  }
  
  /* Success border animation */
  .success-animation > div {
    animation: successBorder 2s ease-in-out;
  }
  
  @keyframes successBorder {
    0% {
      border-color: rgb(229, 231, 235);
    }
    25% {
      border-color: rgb(34, 197, 94);
    }
    50% {
      border-color: rgb(34, 197, 94);
    }
    75% {
      border-color: rgb(34, 197, 94);
    }
    100% {
      border-color: rgb(229, 231, 235);
    }
  }
  
  /* Dark mode success border */
  .dark .success-animation > div {
    animation: successBorderDark 2s ease-in-out;
  }
  
  @keyframes successBorderDark {
    0% {
      border-color: rgb(55, 65, 81);
    }
    25% {
      border-color: rgb(34, 197, 94);
    }
    50% {
      border-color: rgb(34, 197, 94);
    }
    75% {
      border-color: rgb(34, 197, 94);
    }
    100% {
      border-color: rgb(55, 65, 81);
    }
  }
  
  /* Response Area Styling */
  .chatbot-response {
    line-height: 1.6;
    word-wrap: break-word;
    min-height: auto;
  }
  
  .chatbot-response-text,
  .chatbot-response-text-mobile {
    line-height: 1.6;
    word-wrap: break-word;
  }
  
  /* Bold text styling */
  .chatbot-response-text strong,
  .chatbot-response-text-mobile strong {
    font-weight: 600;
    color: inherit;
  }
  
  .chatbot-response-text em,
  .chatbot-response-text-mobile em {
    font-style: italic;
  }
  
  /* Custom scrollbar for response area */
  .chatbot-response::-webkit-scrollbar {
    width: 6px;
  }
  
  .chatbot-response::-webkit-scrollbar-track {
    background: transparent;
    border-radius: 10px;
  }
  
  .chatbot-response::-webkit-scrollbar-thumb {
    background: rgba(156, 163, 175, 0.5);
    border-radius: 10px;
  }
  
  .chatbot-response::-webkit-scrollbar-thumb:hover {
    background: rgba(156, 163, 175, 0.7);
  }
  
  .dark .chatbot-response::-webkit-scrollbar-thumb {
    background: rgba(75, 85, 99, 0.5);
  }
  
  .dark .chatbot-response::-webkit-scrollbar-thumb:hover {
    background: rgba(75, 85, 99, 0.7);
  }
</style>

<script>
  class SimpleChatbot {
    constructor() {
      this.input = document.getElementById('chatbot-input');
      this.mobileInput = document.getElementById('chatbot-mobile-input');
      this.responseArea = document.getElementById('chatbot-response');
      this.responseText = this.responseArea?.querySelector('.chatbot-response-text');
      this.closeBtn = document.getElementById('chatbot-close-btn');
      this.responseAreaMobile = document.getElementById('chatbot-response-mobile');
      this.responseTextMobile = this.responseAreaMobile?.querySelector('.chatbot-response-text-mobile');
      this.closeBtnMobile = document.getElementById('chatbot-close-btn-mobile');
      this.mobileCollapsed = document.querySelector('.chatbot-mobile-collapsed');
      this.mobileExpanded = document.querySelector('.chatbot-mobile-expanded');
      this.isMobileExpanded = false;
      this.autoCloseTimer = null;
      
      this.conversationHistory = [];
      this.isLoading = false;
      
      this.init();
    }
    
    init() {
      // Desktop input
      this.input.addEventListener('keypress', (e) => {
        if (e.key === 'Enter' && !e.shiftKey && !this.isLoading) {
          e.preventDefault();
          this.handleSend();
        }
      });
      
      this.input.addEventListener('focus', () => {
        this.addFocusEffects();
      });
      
      this.input.addEventListener('blur', () => {
        this.removeFocusEffects();
      });
      
      this.input.addEventListener('input', () => {
        this.handleInputChange();
      });
      
      // Mobile input
      this.mobileInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter' && !e.shiftKey && !this.isLoading) {
          e.preventDefault();
          this.handleMobileSend();
        }
      });
      
      this.mobileInput.addEventListener('focus', () => {
        this.addFocusEffects();
      });
      
      this.mobileInput.addEventListener('blur', () => {
        this.removeFocusEffects();
      });
      
      this.mobileInput.addEventListener('input', () => {
        this.handleMobileInputChange();
      });
      
      // Desktop send icon click handler
      const sendIcon = document.querySelector('.send-icon');
      if (sendIcon) {
        sendIcon.addEventListener('click', () => {
          if (!this.isLoading && this.input.value.trim()) {
            this.handleSend();
          }
        });
        sendIcon.style.cursor = 'pointer';
      }
      
      // Mobile send icon click handler
      const sendIconMobile = document.querySelector('.send-icon-mobile');
      if (sendIconMobile) {
        sendIconMobile.addEventListener('click', () => {
          if (!this.isLoading && this.mobileInput.value.trim()) {
            this.handleMobileSend();
          }
        });
        sendIconMobile.style.cursor = 'pointer';
      }
      
      // Mobile collapsed click handler
      this.mobileCollapsed.addEventListener('click', () => {
        this.toggleMobileExpanded();
      });
      
      // Close button handlers
      if (this.closeBtn) {
        this.closeBtn.addEventListener('click', () => {
          this.hideResponseArea();
        });
      }
      
      if (this.closeBtnMobile) {
        this.closeBtnMobile.addEventListener('click', () => {
          this.hideResponseAreaMobile();
        });
      }
      
      this.updatePlaceholder("Ask me anything...");
    }
    
    addFocusEffects() {
      const container = document.querySelector('.chatbot-container');
      if (container) {
        container.classList.add('focused');
      }
    }
    
    removeFocusEffects() {
      const container = document.querySelector('.chatbot-container');
      if (container) {
        container.classList.remove('focused');
      }
    }
    
    handleInputChange() {
      const sendIcon = document.querySelector('.send-icon');
      if (this.input.value.trim() && !this.isLoading) {
        if (sendIcon) {
          sendIcon.style.opacity = '1';
          sendIcon.style.transform = 'translateX(0)';
        }
      } else {
        if (sendIcon) {
          sendIcon.style.opacity = '0';
          sendIcon.style.transform = 'translateX(10px)';
        }
      }
    }
    
    handleMobileInputChange() {
      const sendIcon = document.querySelector('.send-icon-mobile');
      if (this.mobileInput.value.trim() && !this.isLoading) {
        if (sendIcon) {
          sendIcon.style.opacity = '1';
          sendIcon.style.transform = 'translateX(0)';
        }
      } else {
        if (sendIcon) {
          sendIcon.style.opacity = '0';
          sendIcon.style.transform = 'translateX(10px)';
        }
      }
    }
    
    toggleMobileExpanded() {
      if (!this.isMobileExpanded) {
        // Show expanded state
        this.mobileCollapsed.style.display = 'none';
        this.mobileExpanded.classList.remove('hidden');
        this.mobileExpanded.classList.add('expanded');
        this.isMobileExpanded = true;
        
        // Focus the input after animation
        setTimeout(() => {
          this.mobileInput.focus();
        }, 300);
      } else {
        // Hide expanded state
        this.mobileExpanded.classList.remove('expanded');
        setTimeout(() => {
          this.mobileExpanded.classList.add('hidden');
          this.mobileCollapsed.style.display = 'flex';
          this.isMobileExpanded = false;
        }, 300);
      }
    }
    
    handleMobileSend() {
      const message = this.mobileInput.value.trim();
      if (!message || this.isLoading) return;
      
      // Use the same logic as desktop but with mobile input
      const originalInput = this.input;
      this.input = this.mobileInput;
      this.handleSend();
      this.input = originalInput;
    }
    
    updatePlaceholder(text) {
      this.input.placeholder = text;
      if (this.mobileInput) {
        this.mobileInput.placeholder = text;
      }
    }
    
    showTypingIndicator() {
      this.isLoading = true;
      this.input.disabled = true;
      this.input.value = 'Thinking...';
      this.input.style.color = '#6b7280';
      
      if (this.mobileInput) {
        this.mobileInput.disabled = true;
        this.mobileInput.value = 'Thinking...';
        this.mobileInput.style.color = '#6b7280';
      }
    }
    
    hideTypingIndicator() {
      this.isLoading = false;
      this.input.disabled = false;
      this.input.value = '';
      this.input.style.color = '';
      
      if (this.mobileInput) {
        this.mobileInput.disabled = false;
        this.mobileInput.value = '';
        this.mobileInput.style.color = '';
      }
    }
    
    showBotResponse(text) {
      this.hideTypingIndicator();
      
      // Format text: convert markdown to HTML
      // Convert **bold** to <strong>
      let formattedText = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
      
      // Convert line breaks
      formattedText = formattedText.replace(/\n/g, '<br>');
      
      if (this.responseText) {
        this.responseText.innerHTML = formattedText;
        this.showResponseArea();
      }
      
      if (this.responseTextMobile) {
        this.responseTextMobile.innerHTML = formattedText;
        this.showResponseAreaMobile();
      }
      
      // Auto-hide response after 30 seconds (longer for reading long responses)
      // Clear any existing timer
      if (this.autoCloseTimer) {
        clearTimeout(this.autoCloseTimer);
      }
      this.autoCloseTimer = setTimeout(() => {
        this.hideResponseArea();
        this.hideResponseAreaMobile();
      }, 30000);
    }
    
    showResponseArea() {
      if (this.responseArea) {
        this.responseArea.style.opacity = '1';
        this.responseArea.style.transform = 'translateY(0)';
        this.responseArea.style.pointerEvents = 'auto';
        
        // Show close button
        if (this.closeBtn) {
          this.closeBtn.style.opacity = '1';
          this.closeBtn.style.pointerEvents = 'auto';
        }
      }
    }
    
    hideResponseArea() {
      if (this.responseArea) {
        this.responseArea.style.opacity = '0';
        this.responseArea.style.transform = 'translateY(1rem)';
        this.responseArea.style.pointerEvents = 'none';
        
        // Hide close button
        if (this.closeBtn) {
          this.closeBtn.style.opacity = '0';
          this.closeBtn.style.pointerEvents = 'none';
        }
      }
      
      // Clear auto-close timer
      if (this.autoCloseTimer) {
        clearTimeout(this.autoCloseTimer);
        this.autoCloseTimer = null;
      }
    }
    
    showResponseAreaMobile() {
      if (this.responseAreaMobile) {
        this.responseAreaMobile.style.opacity = '1';
        this.responseAreaMobile.style.transform = 'translateY(0)';
        this.responseAreaMobile.style.pointerEvents = 'auto';
        
        // Show close button
        if (this.closeBtnMobile) {
          this.closeBtnMobile.style.opacity = '1';
          this.closeBtnMobile.style.pointerEvents = 'auto';
        }
      }
    }
    
    hideResponseAreaMobile() {
      if (this.responseAreaMobile) {
        this.responseAreaMobile.style.opacity = '0';
        this.responseAreaMobile.style.transform = 'translateY(1rem)';
        this.responseAreaMobile.style.pointerEvents = 'none';
        
        // Hide close button
        if (this.closeBtnMobile) {
          this.closeBtnMobile.style.opacity = '0';
          this.closeBtnMobile.style.pointerEvents = 'none';
        }
      }
      
      // Clear auto-close timer
      if (this.autoCloseTimer) {
        clearTimeout(this.autoCloseTimer);
        this.autoCloseTimer = null;
      }
    }
    
    async handleSend() {
      const message = this.input.value.trim();
      if (!message || this.isLoading) return;
      
      // Clear input immediately
      const userMessage = message;
      this.input.value = '';
      this.handleInputChange();
      
      // Add to conversation history
      this.conversationHistory.push({
        role: 'user',
        content: userMessage
      });
      
      // Show typing indicator
      this.showTypingIndicator();
      
      try {
        // Prepare request body
        const requestBody = {
          message: userMessage,
          conversationHistory: this.conversationHistory.slice(-10) // Keep last 10 messages
        };
        
        const bodyString = JSON.stringify(requestBody);
        console.log('Sending request:', { message: userMessage.substring(0, 50), bodyLength: bodyString.length });
        
        // Use fetch directly - don't wrap in Request object
        const response = await fetch('/api/chatbot', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json'
          },
          body: bodyString
        });
        
        console.log('ðŸ”µ Client - Response status:', response.status);
        console.log('ðŸ”µ Client - Response ok:', response.ok);
        console.log('ðŸ”µ Client - Response headers:', Object.fromEntries(response.headers.entries()));
        
        if (!response.ok) {
          const errorText = await response.text();
          console.error('ðŸ”´ Client - Error response:', errorText);
          let errorData;
          try {
            errorData = JSON.parse(errorText);
          } catch (e) {
            errorData = { error: 'Unknown error', details: errorText };
          }
          throw new Error(errorData.error || errorData.details || `HTTP ${response.status}`);
        }
        
        const responseText = await response.text();
        console.log('ðŸ”µ Client - Response text:', responseText.substring(0, 200));
        
        const data = JSON.parse(responseText);
        const aiMessage = data.message || 'Sorry, I could not generate a response.';
        
        // Add AI response to conversation history
        this.conversationHistory.push({
          role: 'assistant',
          content: aiMessage
        });
        
        // Show response
        this.showBotResponse(aiMessage);
        
      } catch (error) {
        console.error('Chatbot error:', error);
        const errorMessage = error.message || 'Sorry, there was an error. Please try again.';
        this.showBotResponse(`âŒ ${errorMessage}`);
      }
    }
  }
  
  // Initialize when DOM is loaded
  document.addEventListener('DOMContentLoaded', () => {
    new SimpleChatbot();
  });
</script>
