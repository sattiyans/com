---
import PageLayout from "@layouts/PageLayout.astro";
import Container from "@components/Container.astro";
import { WATCHED } from "@consts";
import type { WatchedItem } from "@types";


export const prerender = false;
---

<PageLayout title={WATCHED.TITLE} description={WATCHED.DESCRIPTION}>
  <Container>
    <div class="space-y-8">
      <!-- Breadcrumb -->
      <nav class="flex items-center space-x-2 text-sm text-gray-600 dark:text-gray-400">
        <a 
          href="/"
          class="hover:text-black dark:hover:text-white transition-colors duration-200"
        >
          Home
        </a>
        <span>/</span>
        <span class="text-black dark:text-white font-medium">Recently Watched</span>
      </nav>

      <!-- Header -->
      <div class="space-y-4">
        <div class="flex items-center justify-between">
          <h1 class="animate font-semibold text-black dark:text-white text-2xl">
            Recently Watched
          </h1>
          <button 
            id="refresh-btn" 
            onclick="loadRealData()" 
            class="flex items-center gap-2 px-3 py-2 text-sm text-gray-600 dark:text-gray-400 hover:text-black dark:hover:text-white border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors duration-200"
            title="Refresh data from Letterboxd"
          >
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
            </svg>
            Refresh
          </button>
        </div>
        <p class="text-gray-600 dark:text-gray-400">
          A collection of films I've recently watched. Follow me on
          <a href="https://letterboxd.com/sattiyans" class="text-blue-600 dark:text-blue-400 hover:underline" target="_blank" rel="noopener noreferrer">Letterboxd</a>.
        </p>
        <div id="last-updated" class="text-xs text-gray-500 dark:text-gray-500">
          <!-- Last updated timestamp will be inserted here -->
        </div>
      </div>


      <!-- Grid of Watched Items -->
      <div id="watched-grid" class="space-y-4">
        <!-- Loading skeleton cards -->
        <div class="animate-pulse">
          <div class="flex items-center gap-3 p-3 border border-black/15 dark:border-white/20 rounded-lg">
            <div class="w-12 h-16 bg-gray-200 dark:bg-gray-700 rounded flex-shrink-0"></div>
            <div class="flex-1">
              <div class="h-4 bg-gray-200 dark:bg-gray-700 rounded w-3/4 mb-2"></div>
              <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                  <div class="h-3 bg-gray-200 dark:bg-gray-700 rounded w-8"></div>
                  <div class="h-3 bg-gray-200 dark:bg-gray-700 rounded w-12"></div>
                </div>
                <div class="flex items-center gap-2">
                  <div class="h-3 bg-gray-200 dark:bg-gray-700 rounded w-12"></div>
                  <div class="h-3 bg-gray-200 dark:bg-gray-700 rounded w-3"></div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="animate-pulse">
          <div class="flex items-center gap-3 p-3 border border-black/15 dark:border-white/20 rounded-lg">
            <div class="w-12 h-16 bg-gray-200 dark:bg-gray-700 rounded flex-shrink-0"></div>
            <div class="flex-1">
              <div class="h-4 bg-gray-200 dark:bg-gray-700 rounded w-3/4 mb-2"></div>
              <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                  <div class="h-3 bg-gray-200 dark:bg-gray-700 rounded w-8"></div>
                  <div class="h-3 bg-gray-200 dark:bg-gray-700 rounded w-12"></div>
                </div>
                <div class="flex items-center gap-2">
                  <div class="h-3 bg-gray-200 dark:bg-gray-700 rounded w-12"></div>
                  <div class="h-3 bg-gray-200 dark:bg-gray-700 rounded w-3"></div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="animate-pulse">
          <div class="flex items-center gap-3 p-3 border border-black/15 dark:border-white/20 rounded-lg">
            <div class="w-12 h-16 bg-gray-200 dark:bg-gray-700 rounded flex-shrink-0"></div>
            <div class="flex-1">
              <div class="h-4 bg-gray-200 dark:bg-gray-700 rounded w-3/4 mb-2"></div>
              <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                  <div class="h-3 bg-gray-200 dark:bg-gray-700 rounded w-8"></div>
                  <div class="h-3 bg-gray-200 dark:bg-gray-700 rounded w-12"></div>
                </div>
                <div class="flex items-center gap-2">
                  <div class="h-3 bg-gray-200 dark:bg-gray-700 rounded w-12"></div>
                  <div class="h-3 bg-gray-200 dark:bg-gray-700 rounded w-3"></div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </Container>
</PageLayout>

<script is:inline>
  // Client-side data fetching
  async function loadRealData() {
    console.log('üé¨ Loading real data from Letterboxd...');
    
    // Show loading state
    const refreshBtn = document.getElementById('refresh-btn');
    if (refreshBtn) {
      refreshBtn.disabled = true;
      refreshBtn.innerHTML = `
        <svg class="w-4 h-4 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
        </svg>
        Loading...
      `;
    }

    try {
      // Fetch data from Letterboxd API with ultra-aggressive cache busting
      const timestamp = Date.now();
      const randomId = Math.random().toString(36).substring(2, 15);
      const cacheBuster = `?t=${timestamp}&r=${randomId}&v=${Math.floor(Math.random() * 10000)}&_=${Date.now()}`;
      const letterboxdResponse = await fetch(`/api/letterboxd${cacheBuster}`, {
        method: 'GET',
        cache: 'no-store',
        headers: {
          'Cache-Control': 'no-cache, no-store, must-revalidate, max-age=0',
          'Pragma': 'no-cache',
          'Expires': 'Thu, 01 Jan 1970 00:00:00 GMT',
          'If-Modified-Since': 'Thu, 01 Jan 1970 00:00:00 GMT',
          'If-None-Match': `"${timestamp}-${randomId}"`,
          'X-Requested-With': 'XMLHttpRequest'
        }
      });

      if (letterboxdResponse.ok) {
        const letterboxdData = await letterboxdResponse.json();
        console.log('‚úÖ Letterboxd data received:', letterboxdData.length, 'items');

        if (letterboxdData && Array.isArray(letterboxdData)) {
          const itemsWithDates = letterboxdData.map((item) => ({
            ...item,
            watchedDate: new Date(item.watchedDate)
          }));
          
          // Sort by watched date (latest first) and take top 10
          const sortedItems = itemsWithDates.sort((a, b) =>
            b.watchedDate.getTime() - a.watchedDate.getTime()
          ).slice(0, 10);

          console.log('üéØ Final items:', sortedItems.length);
          console.log('üìÖ First item:', sortedItems[0]);

          // Update the grid with real data
          updateGrid(sortedItems);
        }
      } else {
        console.error('‚ùå Letterboxd API response not ok:', letterboxdResponse.status);
      }

    } catch (error) {
      console.error('üí• Error loading real data:', error);
    } finally {
      // Restore button state
      if (refreshBtn) {
        refreshBtn.disabled = false;
        refreshBtn.innerHTML = `
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
          </svg>
          Refresh
        `;
      }
    }
  }

  function updateGrid(items) {
    console.log('Updating grid with', items.length, 'items');
    const grid = document.getElementById('watched-grid');
    if (!grid) {
      console.error('Grid element not found');
      return;
    }

    grid.innerHTML = items.map(item => `
      <div class="group">
        <a href="${item.url || '#'}" target="_blank" rel="noopener noreferrer" class="block">
          <div class="flex items-center gap-3 p-3 border border-black/15 dark:border-white/20 rounded-lg hover:bg-black/5 dark:hover:bg-white/5 transition-colors duration-300">
            <!-- Poster -->
            <div class="w-12 h-16 flex-shrink-0 overflow-hidden rounded">
              ${item.posterUrl ?
                `<img src="${item.posterUrl}" alt="Poster for ${item.title}" class="h-full w-full object-cover transition-transform duration-300 group-hover:scale-105" loading="lazy" />` :
                `<div class="flex h-full w-full items-center justify-center bg-gray-200 dark:bg-gray-800 rounded">
                   <span class="text-xs text-gray-500 dark:text-gray-400">No poster</span>
                 </div>`
              }
            </div>
            
            <!-- Content -->
            <div class="flex-1 min-w-0">
              <h3 class="text-sm font-medium text-black dark:text-white truncate mb-1">
                ${item.title}
              </h3>
              <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                  <span class="text-xs text-gray-600 dark:text-gray-400">
                    ${item.year}
                  </span>
                  ${item.rating ? `
                    <span class="text-xs text-yellow-500 font-medium">
                      ${formatRating(item.rating)}
                    </span>
                  ` : ''}
                </div>
                <div class="flex items-center gap-2">
                  <span class="text-xs text-gray-500 dark:text-gray-400">
                    ${new Intl.DateTimeFormat('en-US', {
                      month: 'short',
                      day: 'numeric'
                    }).format(new Date(item.watchedDate))}
                  </span>
                  <svg class="w-3 h-3 text-gray-400 group-hover:text-black dark:group-hover:text-white transition-colors duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                  </svg>
                </div>
              </div>
            </div>
          </div>
        </a>
      </div>
    `).join('');

    console.log('Grid updated successfully');
    
    // Update last updated timestamp
    const lastUpdatedEl = document.getElementById('last-updated');
    if (lastUpdatedEl) {
      const now = new Date();
      lastUpdatedEl.textContent = `Last updated: ${now.toLocaleString()}`;
    }
  }



  function formatRating(rating) {
    if (typeof rating !== 'number') return '';
    
    const fullStars = Math.floor(rating);
    const hasHalfStar = rating % 1 >= 0.5;
    
    let stars = '';
    for (let i = 0; i < fullStars; i++) {
      stars += '‚òÖ';
    }
    if (hasHalfStar) {
      stars += '¬Ω';
    }
    
    return stars;
  }

  // Load real data when page loads
  console.log('üöÄ Page loaded, starting data fetch...');
  loadRealData();
</script> 